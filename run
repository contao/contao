#!/usr/bin/env bash

function phpunit() {
  if [[ ! -e ./vendor/bin/phpunit ]]; then
    echo "The vendor/bin/phpunit file is missing. Did you install the dependencies?"
    exit 1
  fi

  local bundles=(
    calendar-bundle
    core-bundle
    faq-bundle
    installation-bundle
    manager-bundle
    news-bundle
  )

  for bundle in ${bundles[*]}; do
    if [[ $DEPRECATIONS ]]; then
      vendor/bin/phpunit -c "$bundle" "$@"
    else
      SYMFONY_DEPRECATIONS_HELPER='max[self]=0&verbose=0' vendor/bin/phpunit -c "$bundle" "$@"
    fi
  done
}

function functional() {
  if [[ ! -e ./vendor/bin/phpunit ]]; then
    echo "The vendor/bin/phpunit file is missing. Did you install the dependencies?"
    exit 1
  fi

  vendor/bin/phpunit -c core-bundle --testsuite=functional  "$@"
}

function php-cs-fixer() {
  if [[ ! -e ./vendor/bin/php-cs-fixer ]]; then
    echo "The vendor/bin/php-cs-fixer file is missing. Did you install the dependencies?"
    exit 1
  fi

  vendor/bin/php-cs-fixer fix -v "$@"
  vendor/bin/php-cs-fixer fix -v --config .php_cs.legacy "$@"
  vendor/bin/php-cs-fixer fix -v --config .php_cs.template "$@"
}

function phpstan() {
  if [[ ! -e ./vendor/bin/phpstan ]]; then
    echo "The vendor/bin/phpstan file is missing. Did you install the dependencies?"
    exit 1
  fi

  vendor/bin/phpstan analyze core-bundle/src core-bundle/tests --level=3
}

function composer() {
  if [[ ! -e ./vendor/bin/monorepo-tools ]]; then
    echo "The vendor/bin/monorepo-tools file is missing. Did you install the dependencies?"
    exit 1
  fi

  vendor/bin/monorepo-tools composer --validate
}

function usage() {
  cat <<HEREDOC
Usage: ./run [task] [--show-deprecations]
  phpunit       Run the unit tests
  functional    Run the functional tests
  php-cs-fixer  Run the PHP coding style fixer
  phpstan       Run the static PHP analyzer
  composer      Validate the composer.json files
HEREDOC
}

ARGS=()
DEPRECATIONS=''

for var in "${@:2}"; do
  if [[ $var = '--show-deprecations' ]]; then
    DEPRECATIONS=1
  else
    ARGS=("$var" "${ARGS[@]}")
  fi
done

case "$1" in
  phpunit)
    phpunit "${ARGS[@]}"
    exit 0
  ;;
  functional)
    functional "${ARGS[@]}"
    exit 0
  ;;
  php-cs-fixer)
    php-cs-fixer "${ARGS[@]}"
    exit 0
  ;;
  phpstan)
    phpstan
    exit 0
  ;;
  composer)
    composer
    exit 0
  ;;
  all)
    phpunit "${ARGS[@]}"
    functional "${ARGS[@]}"
    php-cs-fixer "${ARGS[@]}"
    phpstan
    composer
    exit 0
  ;;
  *)
    usage
    exit 1
  ;;
esac
