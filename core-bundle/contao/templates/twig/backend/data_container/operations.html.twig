{% trans_default_domain 'contao_default' %}
{% set has_submenu = false %}
{% set show_button = false %}
{% set more_icon_global = more_icon_global|default('more.svg') %}
{% set more_icon = more_icon|default('more.svg') %}
{% set more_alt_global = more_alt_global|default('DCA.global_operations') %}
{% set more_alt = more_alt|default('DCA.operations') %}

<div class="operations"{% if globalOperations %} id="tl_buttons" data-controller="contao--operations-menu" data-action="contextmenu->contao--operations-menu#open"{% endif %}>
    <ul data-contao--operations-menu-target="menu">
        {% for operation in operations %}
            {% set isLink = operation.href|default or (operation.html is defined and ('<a ' in operation.html or '<button ' in operation.html)) %}
            {% set has_submenu = has_submenu or isLink %}
            {% if has_primary and not operation.primary|default(false) %}
                {% set show_button = true %}
            {% else %}
                {{ _self.operation(operation, false, globalOperations) }}
            {% endif %}
        {% endfor %}
        {% if has_submenu %}
            <li class="operations-menu-container{% if not show_button %} is-hidden{% endif %}">
                <button type="button" class="has-icon" data-contao--operations-menu-target="controller">
                    {% if globalOperations %}
                        {{ backend_icon(more_icon_global, more_alt_global|trans) }}
                    {% else %}
                        {{ backend_icon(more_icon, more_alt|trans([id|default])) }}
                    {% endif %}
                </button>
                <ul class="operations-menu" data-contao--operations-menu-target="submenu">
                    {% set addSeparator = false %}
                    {% for operation in operations %}
                        {% if operation.separator|default %}
                            {% set addSeparator = true %}
                        {% else %}
                            {{ _self.operation(operation, true, globalOperations, addSeparator) }}
                            {% set addSeparator = false %}
                        {% endif %}
                    {% endfor %}
                </ul>
            </li>
        {% endif %}
    </ul>
</div>

{% macro operation(operation, menu = false, showLabels = false, addSeparator = false) %}
    {% set list_attributes = attrs(menu ? null : operation.listAttributes|default)
        .addClass('separator', addSeparator)
    %}
    {% if operation.html is defined and (not menu or '<a ' in operation.html or '<button ' in operation.html) %}
        {% set list_attributes = list_attributes.set('data-contao--operations-menu-target', 'title', menu and not showLabels) %}
        <li{{ list_attributes }}>{{ operation.html|raw }}</li>
    {% elseif operation.href|default %}
        {% set list_attributes = list_attributes.set('data-contao--operations-menu-target', 'title', menu and not operation.title|default) %}
        <li{{ list_attributes }}>
            {% set operation_attributes = attrs(operation.attributes|default)
                .set('title', operation.title|default, ((menu or showLabels) and operation.title|default != operation.label|default))
                .addClass('has-icon', operation.icon|default)
            %}
            {% if operation.method|default('GET') != 'GET' %}
                <form action="{{ operation.href }}" method="POST">
                    {% if operation.method != 'POST' %}<input type="hidden" name="_method" value="{{ operation.method }}">{% endif %}
                    <input type="hidden" name="REQUEST_TOKEN" value="{{ contao.request_token }}">
                    <button type="submit"{{ operation_attributes }}>
                        {% if operation.icon|default %}{{ backend_icon(operation.icon, (menu or showLabels) ? '' : operation.title|default(operation.label|default), operation.iconAttributes|default(null)) }}{% endif %}
                        {% if menu or showLabels %}{{ operation.label|default }}{% endif %}
                    </button>
                </form>
            {% else %}
                {% set operation_attributes = operation_attributes
                    .set('href', operation.href)
                %}
                <a{{ operation_attributes }}>
                    {% if operation.icon|default %}{{ backend_icon(operation.icon, (menu or showLabels) ? '' : operation.title|default(operation.label|default), operation.iconAttributes|default(null)) }}{% endif %}
                    {% if menu or showLabels %}{{ operation.label|default }}{% endif %}
                </a>
            {% endif %}
        </li>
    {% elseif operation.icon|default and not menu %}
        <li{{ list_attributes }}>
            {{ backend_icon(operation.icon, (menu or showLabels) ? '' : operation.title|default(operation.label|default), operation.iconAttributes|default(null)) }}
            {% if menu or showLabels %}{{ operation.label|default }}{% endif %}
        </li>
    {% endif %}
{% endmacro %}
